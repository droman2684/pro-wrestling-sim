{% extends "base.html" %}

{% block title %}Show Runner - Pro Wrestling Sim{% endblock %}

{% block content %}

<!-- Production Pipeline (Progress Bar) -->
<div class="card border-0 shadow-sm mb-4 overflow-hidden">
    <div class="card-body p-0">
        <div class="d-flex text-center">
            <!-- Stage 1 -->
            <div class="flex-fill p-3 border-end position-relative {{ 'bg-brand text-white' if not current_show else 'bg-light text-muted' }}">
                <div class="fw-bold text-uppercase small ls-1">1. Selection</div>
                {% if not current_show %}
                <div class="position-absolute bottom-0 start-50 translate-middle-x bg-white" style="width: 10px; height: 10px; transform: rotate(45deg); margin-bottom: -5px;"></div>
                {% endif %}
            </div>
            <!-- Stage 2 -->
            <div class="flex-fill p-3 border-end position-relative {{ 'bg-brand text-white' if current_show and current_show.match_count == 0 else ('bg-success text-white' if current_show and current_show.match_count > 0 else 'bg-light text-muted') }}">
                <div class="fw-bold text-uppercase small ls-1">2. Booking</div>
                {% if current_show %}
                <div class="position-absolute bottom-0 start-50 translate-middle-x bg-white" style="width: 10px; height: 10px; transform: rotate(45deg); margin-bottom: -5px;"></div>
                {% endif %}
            </div>
            <!-- Stage 3 -->
            <div class="flex-fill p-3 {{ 'bg-brand text-white' if current_show and current_show.match_count > 0 else 'bg-light text-muted' }}">
                <div class="fw-bold text-uppercase small ls-1">3. Production</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- LEFT COLUMN: WORKSPACE -->
    <div class="col-lg-8">

        {% if not current_show %}
        <!-- STEP 1: EVENT SELECTION -->
        <h4 class="fw-bold text-brand mb-3">Select Event</h4>
        
        {% if unbooked_shows %}
        <div class="mb-4">
            <h6 class="text-uppercase text-muted fw-bold small mb-3">Scheduled This Week</h6>
            <form action="{{ url_for('select_show') }}" method="post">
                <div class="row g-3">
                    {% for show in unbooked_shows %}
                    <div class="col-12">
                        <label class="card border-0 shadow-sm hover-lift cursor-pointer h-100 position-relative">
                            <input type="radio" name="show_id" value="{{ show.id }}" class="position-absolute opacity-0" {% if loop.index == 1 %}checked{% endif %}>
                            <div class="card-body d-flex align-items-center">
                                <div class="rounded-circle bg-light border d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                    {% if show.show_type == 'ppv' %}
                                        <i class="bi bi-star-fill text-danger fs-4"></i>
                                    {% else %}
                                        <i class="bi bi-tv text-primary fs-4"></i>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="fw-bold mb-0 text-dark">{{ show.name }}</h5>
                                        {% if show.brand_id %}
                                            {% for brand in game.get_active_brands() %}
                                                {% if brand.id == show.brand_id %}
                                                    <span class="badge" style="background-color: {{ brand.color }};">{{ brand.short_name }}</span>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    <div class="text-muted small">
                                        <span class="text-uppercase fw-bold">{{ show.day_of_week.name }}</span> &bull; Arena Capacity: 15,000
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <span class="btn btn-outline-primary btn-sm rounded-pill px-3">Select</span>
                                </div>
                            </div>
                            <!-- Selection Highlight Border -->
                            <div class="position-absolute top-0 start-0 w-100 h-100 border border-2 border-primary rounded opacity-0 check-highlight"></div>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary fw-bold px-4">
                        Confirm Selection <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                </div>
            </form>
        </div>
        <hr class="my-4 text-muted opacity-25">
        {% endif %}

        <!-- Custom Show Creator -->
        <div>
            <h6 class="text-uppercase text-muted fw-bold small mb-3">Create Custom Event</h6>
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form action="{{ url_for('create_show') }}" method="post" class="row g-3 align-items-end">
                        <div class="col-md-9">
                            <label class="form-label fw-bold small text-muted">EVENT NAME</label>
                            <input type="text" name="show_name" class="form-control" placeholder="e.g. Saturday Night Special" required>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-dark w-100 fw-bold">Create</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% else %}
        <!-- STEP 2 & 3: BOOKING & PRODUCTION -->
        
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h4 class="fw-bold text-brand mb-0">{{ current_show.name }}</h4>
                <small class="text-muted">Run Sheet &bull; {{ current_show.matches|length }} Matches Booked</small>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('ai_booking') }}" class="btn btn-sm btn-outline-primary fw-bold">
                    <i class="bi bi-magic me-2"></i>AI Auto-Book
                </a>
                <form action="{{ url_for('cancel_show') }}" method="post" onsubmit="return confirm('Are you sure you want to cancel this show?');">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- THE RUN SHEET (Booked Matches) -->
        {% if current_show.match_count == 0 %}
        <div class="card border-2 border-dashed border-secondary bg-light mb-4 text-center py-5">
            <div class="py-4">
                <div class="rounded-circle bg-white border d-inline-flex align-items-center justify-content-center mb-3" style="width: 64px; height: 64px;">
                    <i class="bi bi-clipboard-plus text-muted fs-3"></i>
                </div>
                <h5 class="fw-bold text-muted">The Card is Empty</h5>
                <p class="text-muted small mb-0">Use the Toolbox below to book your first match.</p>
            </div>
        </div>
        {% else %}
        <div class="mb-4">
            {% for match in current_show.matches %}
            <div class="card border-0 shadow-sm mb-3 position-relative overflow-hidden">
                <!-- Match Number Strip -->
                <div class="position-absolute top-0 start-0 bottom-0 bg-dark text-white d-flex align-items-center justify-content-center" style="width: 30px;">
                    <span class="fw-bold small">{{ loop.index }}</span>
                </div>
                
                <div class="card-body p-3" style="margin-left: 30px;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-light text-dark border">{{ match.match_type }}</span>
                        <div class="d-flex gap-1">
                            {% if match.is_title_match %}<span class="badge bg-warning text-dark border border-warning"><i class="bi bi-trophy-fill me-1"></i>Title</span>{% endif %}
                            {% if match.is_steel_cage %}<span class="badge bg-dark"><i class="bi bi-grid-3x3 me-1"></i>Cage</span>{% endif %}
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center justify-content-around my-2">
                        <!-- Competitor A -->
                        <div class="text-center" style="width: 45%;">
                            {% if match.match_type == "Tag Team" %}
                                <div class="fw-bold text-truncate">{{ match.team_a.name }}</div>
                            {% else %}
                                <div class="fw-bold text-truncate">{{ match.p1.name }}</div>
                                <div class="small text-muted">{{ match.p1.overall_rating }} OVR</div>
                            {% endif %}
                        </div>
                        
                        <!-- VS -->
                        <div class="fw-bold text-muted italic font-monospace">VS</div>
                        
                        <!-- Competitor B -->
                        <div class="text-center" style="width: 45%;">
                            {% if match.match_type == "Tag Team" %}
                                <div class="fw-bold text-truncate">{{ match.team_b.name }}</div>
                            {% else %}
                                <div class="fw-bold text-truncate">{{ match.p2.name }}</div>
                                <div class="small text-muted">{{ match.p2.overall_rating }} OVR</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            {% for match in current_show.multi_man_matches %}
            <!-- Multi-man matches simplified view -->
             <div class="card border-0 shadow-sm mb-3 position-relative overflow-hidden">
                <div class="position-absolute top-0 start-0 bottom-0 bg-dark text-white d-flex align-items-center justify-content-center" style="width: 30px;">
                    <span class="fw-bold small">{{ current_show.matches|length + loop.index }}</span>
                </div>
                <div class="card-body p-3" style="margin-left: 30px;">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge bg-light text-dark border">Multi-Man</span>
                        {% if match.title_id %}<span class="badge bg-warning text-dark"><i class="bi bi-trophy-fill"></i> Title</span>{% endif %}
                    </div>
                    <div class="fw-bold text-center">
                        {% for w in match.participants %}
                            {{ w.name }}{% if not loop.last %} <span class="text-muted fw-normal mx-2">vs</span> {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- THE TOOLBOX (Booking Accordions) -->
        <h6 class="text-uppercase text-muted fw-bold small mb-3">Booking Toolbox</h6>
        
        <div class="accordion shadow-sm rounded overflow-hidden mb-5" id="bookingToolbox">
            
            <!-- Tool: Singles Match -->
            <div class="accordion-item border-0 border-bottom">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#toolSingles">
                        <i class="bi bi-person-fill me-2 text-primary"></i>Book Singles Match
                    </button>
                </h2>
                <div id="toolSingles" class="accordion-collapse collapse" data-bs-parent="#bookingToolbox">
                    <div class="accordion-body bg-light">
                        <form action="{{ url_for('add_singles_match') }}" method="post">
                            <div class="row g-2 align-items-center">
                                <div class="col-md-5">
                                    <select name="wrestler_a" class="form-select wrestler-select" required>
                                        <option value="">Select Wrestler A...</option>
                                        {% for w in wrestlers %}
                                        <option value="{{ w.id }}" data-name="{{ w.name|lower }}" data-alignment="{{ w.alignment }}" data-style="{{ w.primary_style }}">{{ w.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2 text-center text-muted fw-bold">VS</div>
                                <div class="col-md-5">
                                    <select name="wrestler_b" class="form-select wrestler-select" required>
                                        <option value="">Select Wrestler B...</option>
                                        {% for w in wrestlers %}
                                        <option value="{{ w.id }}" data-name="{{ w.name|lower }}" data-alignment="{{ w.alignment }}" data-style="{{ w.primary_style }}">{{ w.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-12 border-top my-2"></div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input type="checkbox" name="title_match" class="form-check-input" id="singlesTitle">
                                        <label class="form-check-label small" for="singlesTitle">Championship Match</label>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <select name="title_id" class="form-select form-select-sm">
                                        <option value="">Select Title (Optional)...</option>
                                        {% for t in titles %}
                                        <option value="{{ t.id }}">{{ t.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input type="checkbox" name="steel_cage" class="form-check-input" id="singlesCage">
                                        <label class="form-check-label small" for="singlesCage">Steel Cage</label>
                                    </div>
                                </div>
                                <div class="col-12 mt-3">
                                    <button type="submit" class="btn btn-primary w-100 fw-bold">Add to Card</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tool: Tag Team -->
            <div class="accordion-item border-0 border-bottom">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#toolTag">
                        <i class="bi bi-people-fill me-2 text-info"></i>Book Tag Team Match
                    </button>
                </h2>
                <div id="toolTag" class="accordion-collapse collapse" data-bs-parent="#bookingToolbox">
                    <div class="accordion-body bg-light">
                        <form action="{{ url_for('add_tag_match') }}" method="post">
                            <div class="row g-2 align-items-center">
                                <div class="col-md-5">
                                    <select name="team_a" class="form-select" required>
                                        <option value="">Select Team A...</option>
                                        {% for t in tag_teams %}
                                        <option value="{{ t.id }}">{{ t.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2 text-center text-muted fw-bold">VS</div>
                                <div class="col-md-5">
                                    <select name="team_b" class="form-select" required>
                                        <option value="">Select Team B...</option>
                                        {% for t in tag_teams %}
                                        <option value="{{ t.id }}">{{ t.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-12 mt-3">
                                    <button type="submit" class="btn btn-info text-white w-100 fw-bold">Add to Card</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

             <!-- Tool: Multi-Man -->
            <div class="accordion-item border-0">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#toolMulti">
                        <i class="bi bi-collection-fill me-2 text-warning"></i>Book Multi-Man Match
                    </button>
                </h2>
                <div id="toolMulti" class="accordion-collapse collapse" data-bs-parent="#bookingToolbox">
                    <div class="accordion-body bg-light">
                         <form action="{{ url_for('add_multi_match') }}" method="post">
                            <div class="mb-2">
                                <label class="form-label text-muted small fw-bold mb-1">SELECT PARTICIPANTS (3-4)</label>
                                <select name="wrestlers" class="form-select wrestler-select" multiple size="6" required>
                                    {% for w in wrestlers %}
                                    <option value="{{ w.id }}" data-name="{{ w.name|lower }}" data-alignment="{{ w.alignment }}" data-style="{{ w.primary_style }}">{{ w.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-warning text-dark w-100 fw-bold">Add to Card</button>
                         </form>
                    </div>
                </div>
            </div>

        </div>

        {% endif %}
    </div>

    <!-- RIGHT COLUMN: CONTROL PANEL -->
    <div class="col-lg-4">
        
        {% if current_show and current_show.match_count > 0 %}
        <!-- PRODUCTION CONTROLS -->
        <div class="card border-0 shadow-sm mb-4 bg-brand text-white">
            <div class="card-body">
                <h6 class="text-white-50 text-uppercase small fw-bold mb-3">Show Control</h6>
                <form action="{{ url_for('run_show') }}" method="post">
                    <button type="submit" class="btn btn-success btn-lg w-100 fw-bold shadow mb-2">
                        <i class="bi bi-broadcast me-2"></i>GO LIVE
                    </button>
                </form>
                <div class="text-center small text-white-50">
                    Runs simulation for all booked matches
                </div>
            </div>
        </div>
        {% endif %}

        {% if current_show %}
        <!-- ROSTER FILTER -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom fw-bold small text-muted text-uppercase">
                <i class="bi bi-funnel-fill me-2"></i>Smart Filter
            </div>
            <div class="card-body bg-light">
                <div class="mb-2">
                    <input type="text" id="filterName" class="form-control" placeholder="Search talent...">
                </div>
                <div class="row g-2">
                    <div class="col-6">
                        <select id="filterAlignment" class="form-select form-select-sm">
                            <option value="">All Alignments</option>
                            <option value="Face">Face</option>
                            <option value="Heel">Heel</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <select id="filterStyle" class="form-select form-select-sm">
                            <option value="">All Styles</option>
                            <option value="brawler">Brawler</option>
                            <option value="technical">Technician</option>
                            <option value="high_flyer">High Flyer</option>
                            <option value="powerhouse">Powerhouse</option>
                        </select>
                    </div>
                </div>
                <div class="mt-2 text-end small text-muted fst-italic" id="matchCount">
                    Ready to filter
                </div>
            </div>
        </div>

        <!-- FEUD TRACKER -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom fw-bold small text-muted text-uppercase">
                <i class="bi bi-fire me-2"></i>Active Storylines
            </div>
            <ul class="list-group list-group-flush">
                {% for feud in game.get_active_feuds()[:5] %}
                    {% set w1 = game.get_wrestler_by_id(feud.wrestler_a_id) %}
                    {% set w2 = game.get_wrestler_by_id(feud.wrestler_b_id) %}
                    <li class="list-group-item d-flex justify-content-between align-items-center small">
                        <span>{{ w1.name }} vs {{ w2.name }}</span>
                        <span class="badge {{ 'bg-danger' if feud.intensity == 'blood' else 'bg-warning text-dark' }}">{{ feud.intensity }}</span>
                    </li>
                {% else %}
                    <li class="list-group-item text-center text-muted small">No active feuds</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

    </div>
</div>

<style>
    /* Custom Check Highlight for Radio Cards */
    input[type="radio"]:checked ~ .check-highlight {
        opacity: 1 !important;
    }
</style>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterName = document.getElementById('filterName');
        const filterAlignment = document.getElementById('filterAlignment');
        const filterStyle = document.getElementById('filterStyle');
        const matchCount = document.getElementById('matchCount');
        
        // Select all selects that have class 'wrestler-select'
        const wrestlerSelects = document.querySelectorAll('.wrestler-select');

        function applyFilters() {
            if (!wrestlerSelects.length) return;

            const nameVal = filterName.value.toLowerCase().trim();
            const alignVal = filterAlignment.value;
            const styleVal = filterStyle.value;

            wrestlerSelects.forEach(select => {
                const options = select.querySelectorAll('option');
                options.forEach(option => {
                    if (!option.value) return; // Skip placeholder

                    const name = option.getAttribute('data-name') || '';
                    const align = option.getAttribute('data-alignment') || '';
                    const style = option.getAttribute('data-style') || '';

                    let show = true;
                    if (nameVal && !name.includes(nameVal)) show = false;
                    if (alignVal && align !== alignVal) show = false;
                    if (styleVal && style !== styleVal) show = false;

                    option.hidden = !show;
                    option.disabled = !show;
                });
            });

            // Update count display based on first select
            let visible = 0;
            wrestlerSelects[0].querySelectorAll('option').forEach(opt => {
                if(opt.value && !opt.hidden) visible++;
            });
            if(matchCount) matchCount.innerText = `${visible} wrestlers available`;
        }

        if (filterName) {
            filterName.addEventListener('input', applyFilters);
            filterAlignment.addEventListener('change', applyFilters);
            filterStyle.addEventListener('change', applyFilters);
        }
    });
</script>
{% endblock %}